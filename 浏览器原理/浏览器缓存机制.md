# 浏览器缓存机制
## 缓存行为
+ 浏览器每次发起请求，都会先在浏览器缓存中查找该请求的结果以及缓存标识
+ 浏览器每次拿到返回的请求结果都会将该结果和缓存标识存入浏览器缓存中


> 强制缓存优先于协商缓存进行，若强缓存生效则直接使用强缓存，若强缓存不生效则进行协商缓存

> 协商缓存由`服务器`决定是否使用缓存；若协商缓存失效，那么就返回`200`，重新返回资源和缓存标识，再存入浏览器缓存中；若协商缓存生效则返回`304`，继续使用缓存。


## 缓存位置
- `Service Worke`r：是运行在浏览器背后的独立线程，无法直接访问`DOM`，但可以用来做离线缓存、消息推送和网络代理。传输协议必须为 `HTTPS`。
- `Memory Cache`：内存中的缓存
- `Disk Cache`：存储在硬盘中的缓存
- `Push Cache`: （`推送缓存`）是 `HTTP/2` 中的内容；

> 注：`HTTP2`的服务器推送功能，在`Chrome106`版本后不可用；

## 缓存过程
- 浏览器第一次加载资源，服务器返回200，浏览器将资源文件从服务器上请求下载下来，并把`response header`及该请求的返回时间一并缓存；
- 下一次加载资源时，先比较当前时间和上一次返回`200`时的时间差，如果没有超过`cache-control`设置的`max-age`，则没有过期，命中强缓存，不发请求直接从本地缓存读取该文件（如果浏览器不支持`HTTP1.1`，则用`expires`判断是否过期）；如果时间过期，则向服务器发送`header`带有`If-None-Match`和`If-Modified-Since`的请求
- 服务器收到请求后，优先根据 `Etag` 的值判断被请求的文件有没有做修改，`Etag` 值一致则没有修改，命中协商缓存，返回`304`；如果不一致则有改动，直接返回新的资源文件带上新的`Etag`值并返回`200`；
- 如果服务器收到的请求没有 `Etag` 值，则将 `If-Modified-Since` 和被请求文件的最后修改时间做比对，一致则命中协商缓存，返回`304`；不一致则返回新的 `last-modified` 和文件并返回`200`；


## 强缓存

### 缓存标识
- 强缓存可以通过设置两种 `HTTP Header` 实现：`Expires` 和 `Cache-Control` 。强缓存表示在缓存期间不需要发送请求
- `Expires` 是 `HTTP/1.0` 的产物。值代表的是服务端的时间，并且 `Expires` 受限于本地时间，如果修改了本地时间，可能会造成缓存失效。
- `Cache-Control` 出现于 `HTTP/1.1`，优先级高于 `Expires` 。该属性值表示资源会在 多少秒后过期，需要再次请求。
  
| 字段 | 协议版本 | 缓存类型 | 响应头 | 请求头 |
| --- | --- | --- | --- | --- |
| Expries | HTTP1.0 | 强缓存 | √ | × | 
| Cachel-Control | HTTP1.1 | 强缓存 | √ | × | 

### Cache-Control 属性
`Cache-Control` 首部字段是 `HTTP/1.1` 中定义缓存的字段，其用于控制缓存的行为，可以组合使用多种指令，多个指令之间可以通过 “,” 分隔

```javascript
// eg：
Cache-Control: max-age:3600, s-maxage=3600, public
Cache-Control: no-cache
```
- `max-age` 指令 给出了缓存过期的相对时间，单位为秒数。时间是相对于请求的时间。
- `s-maxage`指令 与 `max-age` 不同之处在于，其只适用于公共缓存服务器，比如资源从源服务器发出后又被中间的代理服务器接收并缓存。当使用 `s-maxage` 指令后，公共缓存服务器将直接忽略 `Expires` 和 `max-age`指令的值。
- `public` 指令表示该资源可以被任何节点缓存（包括客户端和代理服务器）


### no-cache、no-store 的区别


## 协商缓存

## 用户行为对浏览器的影响

## 启发式缓存